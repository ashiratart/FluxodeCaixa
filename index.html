<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caixa</title>
</head>
<body>
    <main class="loja">
        <div id="vendashj">
            <input type="text" name="Tvendas" id="Tvendashj" readonly>
        </div>
        <h1>Esquadrão Moda Fitness</h1>
        <div class="menu">
            <label for="bmenu">Menu</label>
            <ul class="tmenu">
                <li id="produtos"><a href="/paginas/produto.html">Produtos</a></li>
            </ul>
        </div>
        <div class="hj">
            <h1>Caixa Aberto</h1>
            <div id="tabela">
                <table id="Ttabela">
                    <tr>
                        <th>Produto</th>
                        <th>Quantidade</th>
                        <th>Valor</th>
                    </tr>
                    <tr>
                        <td id="1c">Arroz</td>
                        <td id="2c">1</td>
                        <td id="3c">R$25,5</td>
                    </tr>
                </table>
            </div>
                <div id="pord">
                    <span>Código:</span><input name="Tprod" id="Iproduto" type="text" placeholder="123A45B">
                    <span>Quantidade:</span><input name="Tqtd" id="Iquantidade" type="number" min="1">
                    <span>Preço:</span><input name="Tval" id="Ivalor" type="number" min="0">
                    <button id="adicionar">Add</button>
                </div>
            <div id="fim">

                <button class="button" id="canc">
                    <!-- <svg viewBox="0 0 448 512" class="svgIcon"><path d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64S14.3 96 32 96H416c17.7 0 32-14.3 32-32s-14.3-32-32-32H320l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32L53.2 467c1.6 25.3 22.6 45 47.9 45H346.9c25.3 0 46.3-19.7 47.9-45L416 128z"></path></svg> -->
                  </button>

               <button class="ui-btn" onclick="final()">
                <span>
                  Finalizar
                </span>
              </button>
            </div>

            
        </div>
    </main>

    <script>

        // Função para calcular e exibir o total da coluna 3
    function calcularTotal() {
        var tabela = document.getElementById("Ttabela");
        var linhas = tabela.getElementsByTagName("tr");
        var total = 0;

        for (var i = 1; i < linhas.length; i++) { // Começamos do índice 1 para pular o cabeçalho
            var valorCelula = linhas[i].getElementsByTagName("td")[2].textContent;
            total += parseFloat(valorCelula.replace("R$", ""));
        }

        // Formata o total como moeda (real)
        var totalFormatado = "R$" + total.toFixed(2);

        // Exibe o total no elemento vendashj
        document.getElementById("Tvendashj").value = totalFormatado;
    }
        // Quando o botão "Adicionar" é clicado
        document.getElementById("adicionar").addEventListener("click", function() {
            // Pega o código e a quantidade do produto inseridos
            var codigo = document.getElementById("Iproduto").value;
            var quantidade = parseInt(document.getElementById("Iquantidade").value);
            var formData = new FormData();
            formData.append("codigo", codigo);
    
            // Cria uma requisição para buscar informações do produto
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "buscar_produto.php", true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        // Obtém informações do produto do servidor
                        var produto = JSON.parse(xhr.responseText);
    
                        if (quantidade > 0 && quantidade <= parseInt(produto.quantidade)) {
                            // Calcula as novas quantidades e preço
                            var novoQuantidade = parseInt(produto.quantidade) - quantidade;
                            var novoPreco = produto.preco * quantidade;
    
                            // Obtém a tabela e insere uma nova linha
                            var tabela = document.getElementById("Ttabela");
                            var newRow = tabela.insertRow();
    
                            // Insere células na nova linha
                            var cell1 = newRow.insertCell(0);
                            cell1.textContent = produto.nome;
    
                            var cell2 = newRow.insertCell(1);
                            cell2.textContent = quantidade;
    
                            var cell3 = newRow.insertCell(2);
                            cell3.textContent = "R$" + novoPreco.toFixed(2);
    
                            // Atualiza a quantidade no banco de dados
                            atualizarQuantidadeBanco(codigo, novoQuantidade);
                        } else {
                            console.error("Quantidade inválida.");
                        }
                    } else {
                        console.error("Erro na requisição: " + xhr.statusText);
                    }
                }
            };
            xhr.send(formData);
        });
    
        // Função para atualizar a quantidade no banco de dados
        function atualizarQuantidadeBanco(codigo, novaQuantidade) {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "atualizar_quantidade.php", true);
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhr.onreadystatechange = function() {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        console.log("Quantidade atualizada no banco de dados.");
                    } else {
                        console.error("Erro na requisição: " + xhr.statusText);
                    }
                }
            };
            xhr.send("codigo=" + encodeURIComponent(codigo) + "&quantidade=" + novaQuantidade);
            calcularTotal();
        }
    </script>
    
        
        
</body>
</html>
